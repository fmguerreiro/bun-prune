name: Build Linux x64

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Linux x64
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: "19"
    steps:
      - name: Checkout bun fork
        uses: actions/checkout@v4
        with:
          repository: fmguerreiro/bun
          ref: feat/implement-bun-prune
          submodules: recursive

      - name: Install LLVM
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh $LLVM_VERSION all
          rm llvm.sh

      - name: Setup LLVM paths for bun cmake
        run: |
          # bun's cmake looks in /usr/lib/llvm-19/bin, create it with symlinks
          sudo mkdir -p /usr/lib/llvm-19/bin
          for tool in clang clang++ ld.lld llvm-ar llvm-ranlib llvm-link lld llvm-strip; do
            if [ -f "/usr/bin/${tool}-19" ]; then
              sudo ln -sf "/usr/bin/${tool}-19" "/usr/lib/llvm-19/bin/${tool}"
            fi
          done
          # Also add versioned symlinks
          sudo ln -sf /usr/bin/clang-19 /usr/lib/llvm-19/bin/clang-19
          sudo ln -sf /usr/bin/clang++-19 /usr/lib/llvm-19/bin/clang++-19
          # Verify
          ls -la /usr/lib/llvm-19/bin/
          /usr/lib/llvm-19/bin/clang --version | head -1

      - name: Install build deps
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ninja-build libxml2-dev gcc-13 g++-13 libstdc++-13-dev

      - name: Install CMake
        run: |
          wget -q "https://github.com/Kitware/CMake/releases/download/v3.30.5/cmake-3.30.5-linux-x86_64.sh"
          sudo sh cmake-3.30.5-linux-x86_64.sh --skip-license --prefix=/usr/local
          rm cmake-3.30.5-linux-x86_64.sh

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Build
        run: |
          source $HOME/.cargo/env
          rustup install nightly && rustup default nightly
          bun run build:release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bun-linux-x64
          path: build/release/bun
