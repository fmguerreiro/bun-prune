name: Build Linux x64

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Linux x64
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: "19"
    steps:
      - name: Maximize disk space
        run: |
          # Aggressive disk cleanup
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache/Python
          sudo rm -rf /opt/hostedtoolcache/Ruby
          sudo rm -rf /opt/hostedtoolcache/go
          sudo rm -rf /opt/hostedtoolcache/node
          sudo rm -rf /opt/hostedtoolcache/PyPy
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/share/edge_driver
          sudo rm -rf /usr/local/share/gecko_driver
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/swift
          sudo apt-get clean
          df -h

      - name: Setup swap
        run: |
          # Create 8GB swap file
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Checkout bun fork
        uses: actions/checkout@v4
        with:
          repository: fmguerreiro/bun
          ref: feat/implement-bun-prune
          submodules: recursive

      - name: Install LLVM
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh $LLVM_VERSION all
          rm llvm.sh
          # Create symlinks like bun's Dockerfile
          for f in /usr/lib/llvm-$LLVM_VERSION/bin/*; do sudo ln -sf "$f" /usr/bin/; done
          sudo ln -sf /usr/bin/clang-$LLVM_VERSION /usr/bin/clang
          sudo ln -sf /usr/bin/clang++-$LLVM_VERSION /usr/bin/clang++
          sudo ln -sf /usr/bin/lld-$LLVM_VERSION /usr/bin/lld
          sudo ln -sf /usr/bin/llvm-ar-$LLVM_VERSION /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/ld.lld /usr/bin/ld
          sudo ln -sf /usr/bin/clang /usr/bin/cc
          sudo ln -sf /usr/bin/clang++ /usr/bin/c++

      - name: Install build deps
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ninja-build libxml2-dev gcc-13 g++-13 libstdc++-13-dev

      - name: Install CMake
        run: |
          wget -q "https://github.com/Kitware/CMake/releases/download/v3.30.5/cmake-3.30.5-linux-x86_64.sh"
          sudo sh cmake-3.30.5-linux-x86_64.sh --skip-license --prefix=/usr/local
          rm cmake-3.30.5-linux-x86_64.sh

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain none
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          # Install the specific nightly version bun needs (from rust-toolchain.toml)
          source $HOME/.cargo/env
          rustup install nightly-2025-12-10
          rustup default nightly-2025-12-10
          # Clean up download cache
          rm -rf $HOME/.cargo/registry/cache

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Build
        env:
          CC: clang
          CXX: clang++
          AR: llvm-ar-19
          RANLIB: llvm-ranlib-19
          LD: lld-19
          LLVM_VERSION: "19.1.7"
          # Limit parallelism to reduce memory usage
          CMAKE_BUILD_PARALLEL_LEVEL: "2"
        run: |
          source $HOME/.cargo/env
          # Add flag to disable the undefined-var-template warning
          export CXXFLAGS="-Wno-undefined-var-template"
          # Use limited parallelism with ninja
          bun run build:release -- -j 2

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bun-linux-x64
          path: build/release/bun
